services:
  - type: web
    name: soccer-betting
    env: docker
    plan: starter
    autoDeploy: true
    healthCheckPath: /
    envVars:
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: ML_SKIP_STARTUP_TRAIN
        value: "1"
      # Persist prediction cache under data/ so it survives restarts
      - key: PREDICTIONS_CACHE_PATH
        value: "/app/data/predictions_cache.json"
      - key: ODDS_API_KEY
        sync: false
      - key: ODDS_API_REGIONS
        value: "uk,eu,us"
      - key: TZ
        value: UTC
      # Avoid bursty recompute in production; rely on snapshots/offline jobs
      - key: ALLOW_ON_DEMAND_PREDICTIONS
        value: "0"
      # Token to protect cron endpoints (optional but recommended)
      - key: REFRESH_CRON_TOKEN
        sync: false
      # Optional: FBR API access (will auto-generate if absent)
      - key: FBR_API_KEY
        sync: false
      # Optional: publish daily summary JSON to GitHub
      - key: GITHUB_TOKEN
        sync: false
      - key: GITHUB_REPO
        sync: false
      - key: GITHUB_BRANCH
        value: main
      - key: GITHUB_PATH_PREFIX
        value: artifacts/daily_summaries
    disk:
      name: snapshot-data
      mountPath: /app/data
      sizeGB: 1
    previews:
      enabled: true
    
    
    # Scheduled jobs: warm odds hourly, run overnight reconciliation daily
    cronJobs:
      - name: warm-odds-hourly
        schedule: "0 * * * *"  # hourly on the hour (UTC)
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST http://localhost:${PORT:-8000}/api/cron/refresh-bovada -H "Authorization: Bearer $TOKEN"
      - name: snapshot-csv-hourly
        schedule: "5 * * * *"  # hourly +5 minutes
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/snapshot-csv?league=ALL&include_odds_api=true" -H "Authorization: Bearer $TOKEN"
      - name: snapshot-corners-csv-hourly
        schedule: "6 * * * *"  # hourly +6 minutes, after main odds snapshot
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/corners/snapshot-csv?league=ALL" -H "Authorization: Bearer $TOKEN"
      - name: snapshot-goals-csv-hourly
        schedule: "7 * * * *"  # hourly +7 minutes, The Odds API totals if available
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/goals/snapshot-csv?league=ALL" -H "Authorization: Bearer $TOKEN"
      - name: snapshot-actuals-hourly
        schedule: "15 * * * *"  # hourly +15 minutes, goals and corners actuals
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/actuals/snapshot-csv?league=ALL" -H "Authorization: Bearer $TOKEN"
      # Split precompute per league to keep each call small and fast (reduce timeouts)
      - name: precompute-PL
        schedule: "10 * * * *"  # hourly +10 minutes, after snapshots
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/precompute-recommendations?league=PL&edge_threshold=0.03&prob_threshold=0.5" -H "Authorization: Bearer $TOKEN"
      - name: precompute-BL1
        schedule: "11 * * * *"  # hourly +11 minutes
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/precompute-recommendations?league=BL1&edge_threshold=0.03&prob_threshold=0.5" -H "Authorization: Bearer $TOKEN"
      - name: precompute-FL1
        schedule: "12 * * * *"  # hourly +12 minutes
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/precompute-recommendations?league=FL1&edge_threshold=0.03&prob_threshold=0.5" -H "Authorization: Bearer $TOKEN"
      - name: precompute-SA
        schedule: "13 * * * *"  # hourly +13 minutes
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/precompute-recommendations?league=SA&edge_threshold=0.03&prob_threshold=0.5" -H "Authorization: Bearer $TOKEN"
      - name: precompute-PD
        schedule: "14 * * * *"  # hourly +14 minutes
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/precompute-recommendations?league=PD&edge_threshold=0.03&prob_threshold=0.5" -H "Authorization: Bearer $TOKEN"
      - name: capture-closing-nightly
        schedule: "20 3 * * *"  # daily at 03:20 UTC (before reconciliation)
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/capture-closing?force=true" -H "Authorization: Bearer $TOKEN"
      - name: overnight-reconciliation
        schedule: "30 3 * * *"  # daily at 03:30 UTC
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST http://localhost:${PORT:-8000}/api/cron/daily-update -H "Authorization: Bearer $TOKEN"
      - name: snapshot-results-nightly
        schedule: "40 3 * * *"  # daily at 03:40 UTC, after reconciliation
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/results/snapshot-csv?league=ALL" -H "Authorization: Bearer $TOKEN"
      - name: fbrefdata-backfill-nightly
        schedule: "50 3 * * *"  # daily at 03:50 UTC, after results
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/fbrefdata/backfill?league=ALL" -H "Authorization: Bearer $TOKEN"
      - name: fbrapi-backfill-schedule-nightly
        schedule: "55 3 * * *"  # daily at 03:55 UTC, use API provider for schedules
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST "http://localhost:${PORT:-8000}/api/cron/fbrapi/backfill-schedule?league=ALL" -H "Authorization: Bearer $TOKEN"
      - name: fetch-corners-fbref-PL
        schedule: "0 2 * * 1"  # weekly Monday 02:00 UTC
        command: |
          curl -s -X POST "http://localhost:${PORT:-8000}/api/admin/corners/fetch-fbref?league=PL&weeks=1-38" 
      - name: fetch-corners-fbref-BL1
        schedule: "5 2 * * 1"
        command: |
          curl -s -X POST "http://localhost:${PORT:-8000}/api/admin/corners/fetch-fbref?league=BL1&weeks=1-34" 
      - name: fetch-corners-fbref-FL1
        schedule: "10 2 * * 1"
        command: |
          curl -s -X POST "http://localhost:${PORT:-8000}/api/admin/corners/fetch-fbref?league=FL1&weeks=1-34" 
      - name: fetch-corners-fbref-SA
        schedule: "15 2 * * 1"
        command: |
          curl -s -X POST "http://localhost:${PORT:-8000}/api/admin/corners/fetch-fbref?league=SA&weeks=1-38" 
      - name: fetch-corners-fbref-PD
        schedule: "20 2 * * 1"
        command: |
          curl -s -X POST "http://localhost:${PORT:-8000}/api/admin/corners/fetch-fbref?league=PD&weeks=1-38" 
      - name: auto-tune-blend-weekly
        schedule: "0 4 * * 1"  # every Monday 04:00 UTC (after nightly jobs)
        command: |
          TOKEN=${REFRESH_CRON_TOKEN:-} ; \
          curl -s -X POST http://localhost:${PORT:-8000}/api/cron/auto-tune-blend -H "Authorization: Bearer $TOKEN"
